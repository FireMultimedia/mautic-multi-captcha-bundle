# NGINX CORS Configuration for MauticMultiCaptchaBundle
# Add this to your Mautic server block BEFORE any other location rules

# CORS headers for ALTCHA API challenge endpoint - MUST BE FIRST
location = /altcha/api/challenge {
    # Always add CORS headers
    add_header Access-Control-Allow-Origin "*" always;
    add_header Access-Control-Allow-Methods "GET, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Content-Type, X-Requested-With, X-Altcha-Spam-Filter, Cache-Control" always;
    add_header Access-Control-Max-Age 86400 always;
    
    # Handle preflight requests
    if ($request_method = 'OPTIONS') {
        add_header Access-Control-Allow-Origin "*";
        add_header Access-Control-Allow-Methods "GET, OPTIONS";
        add_header Access-Control-Allow-Headers "Content-Type, X-Requested-With, X-Altcha-Spam-Filter, Cache-Control";
        add_header Access-Control-Max-Age 86400;
        add_header Content-Length 0;
        add_header Content-Type text/plain;
        return 204;
    }
    
    # Pass to PHP
    try_files $uri $uri/ /index.php?$query_string;
}

# Alternative: Broader ALTCHA API location (if exact match doesn't work)
location ~* ^/altcha/api/ {
    # Always add CORS headers
    add_header Access-Control-Allow-Origin "*" always;
    add_header Access-Control-Allow-Methods "GET, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Content-Type, X-Requested-With, X-Altcha-Spam-Filter, Cache-Control" always;
    add_header Access-Control-Max-Age 86400 always;
    
    # Handle preflight requests
    if ($request_method = 'OPTIONS') {
        add_header Access-Control-Allow-Origin "*";
        add_header Access-Control-Allow-Methods "GET, OPTIONS";
        add_header Access-Control-Allow-Headers "Content-Type, X-Requested-With, X-Altcha-Spam-Filter, Cache-Control";
        add_header Access-Control-Max-Age 86400;
        add_header Content-Length 0;
        add_header Content-Type text/plain;
        return 204;
    }
    
    # Pass to PHP
    try_files $uri $uri/ /index.php?$query_string;
}

# CORS headers for MauticMultiCaptchaBundle assets
location ~* ^/plugins/MauticMultiCaptchaBundle/Assets/.*\.js$ {
    add_header Access-Control-Allow-Origin "*" always;
    add_header Access-Control-Allow-Methods "GET, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Content-Type, X-Requested-With" always;
    
    # Handle preflight requests
    if ($request_method = 'OPTIONS') {
        add_header Access-Control-Allow-Origin "*";
        add_header Access-Control-Allow-Methods "GET, OPTIONS";
        add_header Access-Control-Allow-Headers "Content-Type, X-Requested-With";
        add_header Content-Length 0;
        add_header Content-Type text/plain;
        return 204;
    }
}

# DEBUGGING: Add this temporarily to see if requests reach nginx
# Remove after testing
location = /altcha/api/debug {
    add_header Content-Type "application/json" always;
    add_header Access-Control-Allow-Origin "*" always;
    return 200 '{"debug": "nginx location working", "timestamp": "$time_iso8601"}';
}