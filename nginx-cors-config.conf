# NGINX CORS Configuration for MauticMultiCaptchaBundle
# Add this to your Mautic server block

# CORS headers for MauticMultiCaptchaBundle assets
location ~* ^/plugins/MauticMultiCaptchaBundle/Assets/.*\.js$ {
    add_header Access-Control-Allow-Origin "*" always;
    add_header Access-Control-Allow-Methods "GET, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Content-Type, X-Requested-With" always;
    
    # Handle preflight requests
    if ($request_method = 'OPTIONS') {
        add_header Access-Control-Allow-Origin "*";
        add_header Access-Control-Allow-Methods "GET, OPTIONS";
        add_header Access-Control-Allow-Headers "Content-Type, X-Requested-With";
        add_header Content-Length 0;
        add_header Content-Type text/plain;
        return 204;
    }
}

# CORS headers for Altcha challenge endpoint
location ~* ^/altcha/challenge$ {
    add_header Access-Control-Allow-Origin "*" always;
    add_header Access-Control-Allow-Methods "GET, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Content-Type, X-Requested-With" always;
    
    # Handle preflight requests
    if ($request_method = 'OPTIONS') {
        add_header Access-Control-Allow-Origin "*";
        add_header Access-Control-Allow-Methods "GET, OPTIONS";
        add_header Access-Control-Allow-Headers "Content-Type, X-Requested-With";
        add_header Content-Length 0;
        add_header Content-Type text/plain;
        return 204;
    }
    
    try_files $uri $uri/ /index.php?$query_string;
}

# CORS headers for form submission (if needed by Altcha widget)
location ~* ^/form/submit {
    add_header Access-Control-Allow-Origin "*" always;
    add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Content-Type, X-Requested-With, X-CSRF-Token" always;
    
    # Handle preflight requests
    if ($request_method = 'OPTIONS') {
        add_header Access-Control-Allow-Origin "*";
        add_header Access-Control-Allow-Methods "GET, POST, OPTIONS";
        add_header Access-Control-Allow-Headers "Content-Type, X-Requested-With, X-CSRF-Token";
        add_header Content-Length 0;
        add_header Content-Type text/plain;
        return 204;
    }
    
    try_files $uri $uri/ /index.php?$query_string;
}

# General CORS for API endpoints (optional)
location ~* ^/(api|s)/ {
    add_header Access-Control-Allow-Origin "*" always;
    add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Content-Type, X-Requested-With, Authorization, X-CSRF-Token" always;
    
    # Handle preflight requests
    if ($request_method = 'OPTIONS') {
        add_header Access-Control-Allow-Origin "*";
        add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS";
        add_header Access-Control-Allow-Headers "Content-Type, X-Requested-With, Authorization, X-CSRF-Token";
        add_header Content-Length 0;
        add_header Content-Type text/plain;
        return 204;
    }
    
    try_files $uri $uri/ /index.php?$query_string;
}